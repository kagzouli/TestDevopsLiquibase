node {

    stage('Clean Workspace') {
        deleteDir() // deletes everything in the workspace
    }

    stage('Checkout') {
        git branch: "main", url: "https://github.com/kagzouli/TestDevopsLiquibase.git"
    }

    // Create the zip file db.zip
    stage('Create zip file') {
        dir('src/main/resources') {   // Change working directory
            // Use full path to 7z if needed, or just '7z' if in PATH
            bat '"7z.exe" a -tzip db.zip db'
        }
    }

    // Create the .dar to prepare it to deploy to XLDeploy
    stage('Create .dar') {
        xldCreatePackage(
            artifactsPath: 'src/main/resources', 
            manifestPath: 'xld/deployit-manifest.xml', 
            darPath: "testdevopsliquibase-${BUILD_NUMBER}.dar"
        )
    }

    // Publish the .dar to XL Deploy
    stage('Publish application') {
        xldPublishPackage(
            serverCredentials: 'xldeploy-cred', 
            darPath: "testdevopsliquibase-${BUILD_NUMBER}.dar"
        )
    }
}
