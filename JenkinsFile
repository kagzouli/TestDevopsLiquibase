properties([
    parameters([
        choice(
            name: 'DB_VERSION',
            choices: ['v1.0.0', 'v1.1.0'],
            description: 'Choose the version to deploy'
        )
    ])
])

node {

    stage('Clean Workspace') {
        deleteDir()
    }

    // Checkout Git
    stage('Checkout') {
        checkout([
            $class: 'GitSCM',
            branches: [[name: "tags/${params.DB_VERSION}"]],
            userRemoteConfigs: [[
                url: 'https://github.com/kagzouli/TestDevopsLiquibase.git'
            ]],
            extensions: [[
                $class: 'CloneOption',
                noTags: false
            ]]
        ])
    }

    // Maven clean package + Generate dar
    stage('Create .dar') {
        bat "mvn clean package -Ddb.version=${params.DB_VERSION}"
    }

    // Publish the .dar to XL Deploy
    stage('Publish application') {

        // Read the Maven project version from pom.xml after build
        bat "mvn help:evaluate -Dexpression=project.version -q -DforceStdout > version.txt"
        projectVersion = readFile('version.txt').trim()

        // Publish the package
        xldPublishPackage(
            serverCredentials: 'xldeploy-cred',
            darPath: "target/testdevopsliquibase-${projectVersion}.dar"
        )
    }

    // Deploy to the right environment
    stage('Deploy to env') {
        xldDeploy(
            serverCredentials: 'xldeploy-cred',
            environmentId: 'Environments/TEST/EXAKA/testdevopsliquibase',
            packageId: "Applications/TEST/EXAKA/testdevopsliquibase/${params.DB_VERSION}"
        )
    }
}